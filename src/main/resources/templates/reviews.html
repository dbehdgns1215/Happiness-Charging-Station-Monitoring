<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>리뷰 게시판</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
  <style>
    .review-container { max-width: 900px; margin: auto; }
    .review-item { border: 1px solid #e9ecef; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
    .review-header { display: flex; justify-content: space-between; align-items: center; }
    .review-rating .fa-star { color: #FFD700; }
    .review-content { margin-top: 15px; }
    .search-bar { margin: 20px 0; display: flex; align-items: center; gap: 10px; }
    .user-info { font-size: 0.9em; color: #6c757d; }
    .no-reviews { text-align: center; color: #999; font-size: 1.2em; margin-top: 40px; }

    .dashboardTable { width: 800px; }
    .ratioTd { width: 100px; }
    .rowIcon {
      width: 25px;
      height: 25px;
    }
    .fillGreen { fill: #57965c; }
    .fillGray { fill: #BDBDBD; }
    .fillRed { fill: #c94f4f; }
    .fillYellow { fill: #F6C343; }
    .progressGreen { background: #57965c; }
    .progressGray { background: #BDBDBD; }
    .progressRed { background: #c94f4f; }
    .progressYellow { background: #F6C343; }
  </style>
</head>
<body>
<div class="review-container">
  <h1 class="my-4 text-center">리뷰 게시판</h1>

  <div class="container d-flex justify-content-center">
    <table class="dashboardTable table table-bordered">
      <thead class="table-light">
      <tr>
        <td>레이팅 항목</td>
        <td>레이팅 개수</td>
        <td class="ratioTd">비율</td>
      </tr>
      </thead>
      <tbody class="align-middle">
      <tr>
        <td class="text-start">
          <svg class="rowIcon bi flex-shrink-0 me-2 fillRed" role="img"><use xlink:href="#lightning-charge-fill"/></svg>
          <span class="align-middle">전체 리뷰</span>
        </td>
        <td><div th:text="${reviews}"></div></td>
        <td>
          <div class="progress">
            <div class="progress-bar w-100" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </td>
      </tr>
      <tr>
        <td class="text-start">
          <svg class="rowIcon bi flex-shrink-0 me-2 fillYellow" role="img"><use xlink:href="#lightning-charge-fill"/></svg>
          <span class="align-middle">평균 레이팅</span>
        </td>
        <td><div th:text="${ratingAverage}"></div></td>
      </tr>
      <tr>
        <td class="text-start">
          <svg class="rowIcon bi flex-shrink-0 me-2 fillYellow" role="img"><use xlink:href="#lightning-charge-fill"/></svg>
          <span class="align-middle">5점</span>
        </td>
        <td><div th:text="${ratingFiveCount}"></div></td>
        <td>
          <div class="progress">
            <div class="progress-bar progressYellow" th:style="'width:' + ${#numbers.formatDecimal(ratingFiveCount * 100 / reviews,0,0)} + '%'" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </td>
      </tr>
      <tr>
        <td class="text-start">
          <svg class="rowIcon bi flex-shrink-0 me-2 fillYellow" role="img"><use xlink:href="#lightning-charge-fill"/></svg>
          <span class="align-middle">4점</span>
        </td>
        <td><div th:text="${ratingFourCount}"></div></td>
        <td>
          <div class="progress">
            <div class="progress-bar progressYellow" th:style="'width:' + ${#numbers.formatDecimal(ratingFourCount * 100 / reviews,0,0)} + '%'" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </td>
      </tr>
      <tr>
        <td class="text-start">
          <svg class="rowIcon bi flex-shrink-0 me-2 fillYellow" role="img"><use xlink:href="#lightning-charge-fill"/></svg>
          <span class="align-middle">3점</span>
        </td>
        <td><div th:text="${ratingThreeCount}"></div></td>
        <td>
          <div class="progress">
            <div class="progress-bar progressYellow" th:style="'width:' + ${#numbers.formatDecimal(ratingThreeCount * 100 / reviews,0,0)} + '%'" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </td>
      </tr>
      <tr>
        <td class="text-start">
          <svg class="rowIcon bi flex-shrink-0 me-2 fillYellow" role="img"><use xlink:href="#lightning-charge-fill"/></svg>
          <span class="align-middle">2점</span>
        </td>
        <td><div th:text="${ratingTwoCount}"></div></td>
        <td>
          <div class="progress">
            <div class="progress-bar progressYellow" th:style="'width:' + ${#numbers.formatDecimal(ratingTwoCount * 100 / reviews,0,0)} + '%'" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </td>
      </tr>
      <tr>
        <td class="text-start">
          <svg class="rowIcon bi flex-shrink-0 me-2 fillYellow" role="img"><use xlink:href="#lightning-charge-fill"/></svg>
          <span class="align-middle">1점</span>
        </td>
        <td><div th:text="${ratingOneCount}"></div></td>
        <td>
          <div class="progress">
            <div class="progress-bar progressYellow" th:style="'width:' + ${#numbers.formatDecimal(ratingOneCount * 100 / reviews,0,0)} + '%'" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <!-- 검색 기능 -->
  <form th:action="@{/reviews}" method="get" class="search-bar">
    <select id="city" name="city" class="form-control" onchange="loadDistricts(this.value)">
      <option value="">시 선택</option>
      <th:block th:each="city : ${cities}">
        <option th:value="${city.key}" th:text="${city.key}"></option>
      </th:block>
    </select>

    <select id="district" name="district" class="form-control">
      <option value="">구 선택</option>
    </select>

    <input type="text" class="form-control" name="keyword" placeholder="리뷰 검색어를 입력하세요" required>
    <button type="button" class="btn btn-primary" onclick="searchReviews(event)">검색</button>
  </form>

  <!-- 리뷰 리스트 -->
  <div id="reviews-list"></div>
  <p class="no-reviews" id="no-reviews-message" style="display:none;">등록된 리뷰가 없습니다.</p>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- Thymeleaf로 Map 데이터를 JavaScript로 전달 -->
<script th:inline="javascript">
  /*<![CDATA[*/
  const cities = /*[[${cities}]]*/ {}; // 서버에서 전달된 cities 객체를 JSON 형식으로 가져오기
  /*]]>*/
</script>

<script>
  // 구를 동적으로 채우는 함수
  function loadDistricts(city) {
    const districtSelect = document.getElementById('district');
    districtSelect.innerHTML = '<option value="">구 선택</option>';

    if (city) {
      // 선택된 시에 맞는 구 리스트를 가져옴
      const districts = cities[city];

      if (districts) {
        districts.forEach(function(district) {
          districtSelect.innerHTML += `<option value="${district}">${district}</option>`;
        });
      }
    }
  }
  // 리뷰 데이터를 API에서 받아와서 화면에 출력하는 함수 (초기 로드용)
  function loadReviews() {
    fetch('/api/v1/reviews')
            .then(response => response.json())
            .then(data => {
              const reviews = data.data;
              const reviewsListContainer = document.getElementById('reviews-list');
              const noReviewsMessage = document.getElementById('no-reviews-message');

              // 리뷰가 없으면 "등록된 리뷰가 없습니다." 메시지 표시
              if (reviews.length === 0) {
                noReviewsMessage.style.display = 'block';
                reviewsListContainer.innerHTML = '';
              } else {
                noReviewsMessage.style.display = 'none';
                reviewsListContainer.innerHTML = ''; // 기존 리뷰 초기화

                // 리뷰 리스트 출력
                reviews.forEach(review => {
                  const reviewItem = document.createElement('div');
                  reviewItem.classList.add('review-item');

                  reviewItem.innerHTML = `
              <div class="review-header">
                <div class="user-info">
                  <i class="fas fa-user"></i> 유저 번호 : ${review.userId} | 충전소 : ${review.chargerId} | 별점 : ${review.rating} | 작성일자 : ${review.createdAt}
                </div>
              </div>
              <div class="review-content">${review.reviewContent}</div>
            `;
                  reviewsListContainer.appendChild(reviewItem);
                });
              }
            })
            .catch(error => console.error('Error fetching reviews:', error));
  }

  // 리뷰 검색 결과를 보여주는 함수
  function searchReviews(event) {
    event.preventDefault();  // 페이지 새로고침 방지

    const city = document.getElementById('city').value;
    const district = document.getElementById('district').value;
    const keyword = document.querySelector('input[name="keyword"]').value;

    let url = '/api/v1/reviews/search'; // 기본 URL

    // URL에 쿼리 파라미터 추가 (선택한 값에 따라)
    let queryParams = [];

    if (city) {
      queryParams.push(`city=${city}`);
    }
    if (district) {
      queryParams.push(`district=${district}`);
    }
    if (keyword) {
      queryParams.push(`keyword=${keyword}`);
    }

    // 쿼리 파라미터가 있으면 URL에 붙임
    if (queryParams.length > 0) {
      url += '?' + queryParams.join('&');
    }

    // 리뷰를 불러오는 fetch 요청
    fetch(url)
            .then(response => response.json())
            .then(data => {
              const reviews = data.data;
              const reviewsListContainer = document.getElementById('reviews-list');
              const noReviewsMessage = document.getElementById('no-reviews-message');

              // 기존 리뷰 리스트를 초기화 (검색 결과만 나오도록 함)
              reviewsListContainer.innerHTML = '';

              // 리뷰가 없으면 "등록된 리뷰가 없습니다." 메시지 표시
              if (reviews.length === 0) {
                noReviewsMessage.style.display = 'block';
              } else {
                noReviewsMessage.style.display = 'none';

                // 리뷰 리스트 출력
                reviews.forEach(review => {
                  const reviewItem = document.createElement('div');
                  reviewItem.classList.add('review-item');

                  reviewItem.innerHTML = `
                        <div class="review-header">
                            <div class="user-info">
                                <i class="fas fa-user"></i> 유저 번호 : ${review.userId} | 충전소 : ${review.chargerId} | 별점 : ${review.rating} | 작성일자 : ${review.createdAt}
                            </div>
                        </div>
                        <div class="review-content">${review.reviewContent}</div>
                    `;
                  reviewsListContainer.appendChild(reviewItem);
                });
              }
            })
            .catch(error => console.error('Error fetching reviews:', error));
  }

  // 페이지 로드 시 리뷰를 불러옵니다.
  window.onload = loadReviews;
</script>

</body>
</html>

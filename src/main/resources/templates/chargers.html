<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>충전소 지도</title>
    <script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=tg2jn30hid"></script>
    <script type="text/javascript" src="/MarkerClustering.js"></script>
    <style>
        #map {
            width: 100%;
            height: 500px;
        }
    </style>
</head>
<body>
<h1>충전소 지도</h1>
<div id="map"></div>

<script>
    // TODO 내 위치 기능 구현? 관리자 페이지에 이게 필요할까?
    const map = new naver.maps.Map('map', {
        center: new naver.maps.LatLng(37.5665, 126.978),
        zoom: 8
    });

    let markers = [];
    let cluster;
    let openInfoWindow = null;

    // 충전소 데이터 가져오기
    fetch('/api/v1/chargers')               // fetch는 응답 객체를 포함한 Promise를 반환. 다음 .then()에게 전달
        .then(response => response.json())  // JSON 데이터로 변환한 뒤 다음 .then()에게 전달 (.then() 체이닝)
        .then(chargerData => {
            if (!chargerData || chargerData.length === 0) {
                console.warn("충전소 데이터가 없습니다.");
                return;
            }
            // 가져온 충전소 객체 List를 마커로 삽입
            chargerData.forEach(charger => {
                const marker = new naver.maps.Marker({
                    position: new naver.maps.LatLng(charger.latitude, charger.longitude),
                    title: charger.name,
                    map: null               // map 속성은 마커가 어느 지도에 표시될지 관리하는 속성
                });

                markers.push(marker);

                /*
                 * 성능 최적화를 위해 초기에는 마커를 숨겨둠
                 * 클러스터링이 해제되는 경우에만 마커가 지도에 표시
                 *
                 * 클러스터링 해제 조건 만족시에 MarkerClustering 라이브러리에서 처리하는 코드
                 * if (markerInCluster) {
                 *     marker.setMap(null);  // 클러스터에 포함된 경우 숨김
                 * } else {
                 *     marker.setMap(map);   // 클러스터 해제 시 지도에 표시
                 * }
                 */


                // 마커 클릭 시에 보일 정보창
                const infowindow = new naver.maps.InfoWindow({
                    content: `<div style="width:150px;text-align:center;padding:10px;">${charger.name}</div>`
                });

                // 정보창 중복 방지 처리
                naver.maps.Event.addListener(marker, 'click', () => {
                    // 정보창이 열려있는 상태에서 다른 정보창 선택시
                    if (openInfoWindow) {
                        openInfoWindow.close();
                    }
                    infowindow.open(map, marker); // 마커 위치에서 정보창 띄우기
                    openInfoWindow = infowindow;
                });
            });

            // 지도 클릭 시 열린 정보창 닫기
            naver.maps.Event.addListener(map, 'click', () => {
                if (openInfoWindow) {
                    openInfoWindow.close();  // 열린 정보창 닫기
                    openInfoWindow = null;  // 상태 초기화
                }
            });

            // 클러스터 생성 함수
            createCluster(map, markers);
        })
        .catch(error => console.error("데이터 가져오기 오류:", error));

    // FIXME API 호출 해보면서 성능 차이 비교할 필요 있음. 체감상 현재는 많이 개선됐고 클러스터 아이콘과 관련된 코드가 중복되는 느낌이 있으나 분리하지 않으면 해결이 안됨.
    function createCluster(map, markers) {
        if (cluster) {
            // 기존 클러스터들 초기화
            cluster.setMap(null);
        }

        cluster = new MarkerClustering({
            minClusterSize: 3,  // 최소 클러스터 크기, 마커 3개부터 클러스터링
            maxZoom: 19,        // 줌 레벨이 19 이상일 때, 클러스터 해제
            map: map,
            markers: markers,
            gridSize: 200,
            disableClickZoom: true,
            icons: createClusterIcons(),
            stylingFunction: (clusterMarker, count) => {
                const element = clusterMarker.getElement();
                element.innerHTML = `
            <div style="
                position: relative;
                display: flex;
                justify-content: center;
                align-items: center;
                width: 40px;
                height: 40px;
                color: white;
                font-size: 14px;
                font-weight: bold;
                border-radius: 50%;
                cursor: pointer;
                transform: translateY(40px);
                box-sizing: border-box;
                z-index: 99;">
                ${count}
            </div>`;
            }
        });

        function createClusterIcons() {
            return [{
                content: `
            <div style="
                position: absolute;
                width: 40px;
                height: 40px;
                background: url('/cluster-marker.png') no-repeat center;
                background-size: cover;
                border-radius: 50%;
                border: 2px solid white;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
                transform: translateX(-2px);
                z-index: 1;">
            </div>`,
                size: new naver.maps.Size(40, 40),
                anchor: new naver.maps.Point(20, 20),
            }];
        }
    }
</script>
</body>
</html>
